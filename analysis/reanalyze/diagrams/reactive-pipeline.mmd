%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e8f4fd', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#4a90d9', 'lineColor': '#4a90d9', 'secondaryColor': '#f0f7e6', 'tertiaryColor': '#fff5e6'}}}%%
flowchart TB
    subgraph FileLayer["File Layer"]
        RFC[("ReactiveFileCollection<br/>(file change detection)")]
    end

    subgraph FileData["Per-File Data"]
        FD["file_data<br/>(path → file_data option)"]
    end

    subgraph Extracted["Extracted Collections"]
        DECLS["decls<br/>(pos → Decl.t)"]
        ANNOT["annotations<br/>(pos → annotation)"]
        EXCREF["exception_refs<br/>(path → loc_from)"]
    end

    subgraph TypeDeps["ReactiveTypeDeps"]
        DBP["decl_by_path<br/>(path → decl list)"]
        SPR["same_path_refs<br/>(pos → PosSet)"]
        CFR["cross_file_refs<br/>(pos → PosSet)"]
        ATR["all_type_refs<br/>(pos → PosSet)"]
    end

    subgraph ExcDeps["ReactiveExceptionRefs"]
        EXCDECL["exception_decls<br/>(path → loc)"]
        RESOLVED["resolved_refs<br/>(pos → PosSet)"]
    end

    subgraph Output["Combined Output"]
        REFS["All refs<br/>→ Ready for solver"]
    end

    RFC -->|"process_files<br/>(detect changes)"| FD
    FD -->|"flatMap<br/>(extract)"| DECLS
    FD -->|"flatMap<br/>(extract)"| ANNOT
    FD -->|"flatMap<br/>(extract)"| EXCREF

    DECLS -->|"flatMap"| DBP
    DBP -->|"flatMap"| SPR
    DBP -->|"join"| CFR
    SPR --> ATR
    CFR --> ATR

    DECLS -->|"flatMap"| EXCDECL
    EXCDECL -->|"join"| RESOLVED
    EXCREF -->|"join"| RESOLVED

    ATR --> REFS
    RESOLVED --> REFS

    classDef fileLayer fill:#e8f4fd,stroke:#4a90d9,stroke-width:2px
    classDef extracted fill:#f0f7e6,stroke:#6b8e23,stroke-width:2px
    classDef typeDeps fill:#fff5e6,stroke:#d4a574,stroke-width:2px
    classDef excDeps fill:#f5e6ff,stroke:#9966cc,stroke-width:2px
    classDef output fill:#e6ffe6,stroke:#2e8b2e,stroke-width:2px

    class RFC,FD fileLayer
    class DECLS,ANNOT,EXCREF extracted
    class DBP,SPR,CFR,ATR typeDeps
    class EXCDECL,RESOLVED excDeps
    class REFS output

