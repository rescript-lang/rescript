%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e8f4fd', 'primaryTextColor': '#1a1a1a', 'primaryBorderColor': '#4a90d9', 'lineColor': '#4a90d9', 'secondaryColor': '#f0f7e6', 'tertiaryColor': '#fff5e6'}}}%%
flowchart TB
    subgraph FileLayer["File Layer"]
        RFC[("RFC")]
    end

    subgraph FileData["Per-File Data"]
        FD["FD"]
    end

    subgraph Extracted["Extracted (ReactiveMerge)"]
        DECLS["D"]
        ANNOT["A"]
        VREFS["VR"]
        TREFS["TR"]
        CFI["CFI"]
    end

    subgraph TypeDeps["ReactiveTypeDeps"]
        DBP["DBP"]
        ATR["ATR"]
    end

    subgraph ExcDeps["ReactiveExceptionRefs"]
        EXCREF["ER"]
        EXCDECL["ED"]
        RESOLVED["RR"]
    end

    subgraph DeclRefs["ReactiveDeclRefs"]
        DR["DR"]
    end

    subgraph Liveness["ReactiveLiveness"]
        ROOTS["roots"]
        EDGES["edges"]
        FP["fixpoint"]
        LIVE["LIVE"]
    end

    subgraph Solver["ReactiveSolver"]
        DEAD_DECLS["dead_decls"]
        LIVE_DECLS["live_decls"]
        DEAD_MODULES["dead_modules"]
        DEAD_BY_FILE["dead_by_file"]
        REFS_BY_FILE["refs_by_file"]
        ISSUES_BY_FILE["issues_by_file"]
        INCORRECT["incorrect_dead"]
        MOD_REPORTED["mod_reported"]
        MOD_ISSUES["mod_issues"]
    end

    subgraph Report["Report (iter only)"]
        OUTPUT[("REPORT")]
    end

    RFC -->|"process"| FD
    FD -->|"flatMap"| DECLS
    FD -->|"flatMap"| ANNOT
    FD -->|"flatMap"| VREFS
    FD -->|"flatMap"| TREFS
    FD -->|"flatMap"| CFI

    DECLS -->|"flatMap"| DBP
    DBP -->|"union+flatMap"| ATR

    CFI -->|"flatMap"| EXCREF
    DECLS -->|"flatMap"| EXCDECL
    EXCREF -->|"join"| RESOLVED
    EXCDECL -->|"join"| RESOLVED

    DECLS --> DR
    VREFS --> DR
    TREFS --> DR
    ATR --> DR
    RESOLVED --> DR

    DECLS --> ROOTS
    ANNOT --> ROOTS

    DR -->|"flatMap"| EDGES
    ROOTS --> FP
    EDGES --> FP
    FP -->|"fixpoint"| LIVE

    DECLS -->|"join (NOT in live)"| DEAD_DECLS
    LIVE -->|"join"| DEAD_DECLS
    DECLS -->|"join (IN live)"| LIVE_DECLS
    LIVE -->|"join"| LIVE_DECLS

    DEAD_DECLS -->|"flatMap (anti-join)"| DEAD_MODULES
    LIVE_DECLS -->|"flatMap (anti-join)"| DEAD_MODULES

    DEAD_DECLS -->|"flatMap by file"| DEAD_BY_FILE
    VREFS -->|"flatMap by file"| REFS_BY_FILE

    DEAD_BY_FILE -->|"flatMap"| ISSUES_BY_FILE
    ANNOT -->|"filter"| ISSUES_BY_FILE
    REFS_BY_FILE -->|"hasRefBelow"| ISSUES_BY_FILE

    LIVE_DECLS -->|"join (@dead)"| INCORRECT
    ANNOT -->|"join (@dead)"| INCORRECT

    ISSUES_BY_FILE -->|"flatMap"| MOD_REPORTED
    DEAD_MODULES -->|"join"| MOD_ISSUES
    MOD_REPORTED -->|"join"| MOD_ISSUES

    ISSUES_BY_FILE -->|"iter"| OUTPUT
    INCORRECT -->|"iter"| OUTPUT
    MOD_ISSUES -->|"iter"| OUTPUT

    classDef fileLayer fill:#e8f4fd,stroke:#4a90d9,stroke-width:2px
    classDef extracted fill:#f0f7e6,stroke:#6b8e23,stroke-width:2px
    classDef typeDeps fill:#fff5e6,stroke:#d4a574,stroke-width:2px
    classDef excDeps fill:#f5e6ff,stroke:#9966cc,stroke-width:2px
    classDef declRefs fill:#e6f0ff,stroke:#4a74d9,stroke-width:2px
    classDef liveness fill:#ffe6e6,stroke:#cc6666,stroke-width:2px
    classDef solver fill:#ffe6f0,stroke:#cc6699,stroke-width:2px
    classDef output fill:#e6ffe6,stroke:#2e8b2e,stroke-width:2px

    class RFC,FD fileLayer
    class DECLS,ANNOT,VREFS,TREFS,CFI extracted
    class DBP,ATR typeDeps
    class EXCREF,EXCDECL,RESOLVED excDeps
    class DR declRefs
    class ROOTS,EDGES,FP,LIVE liveness
    class DEAD_DECLS,LIVE_DECLS,DEAD_MODULES,DEAD_BY_FILE,REFS_BY_FILE,ISSUES_BY_FILE,INCORRECT,MOD_REPORTED,MOD_ISSUES solver
    class OUTPUT output
